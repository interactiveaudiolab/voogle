<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Live input record and playback</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.4.0/wavesurfer.min.js"></script>
  <!-- wavesurfer.js microphone -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.2.3/plugin/wavesurfer.microphone.min.js"></script>
  <!-- wavesurfer.js regions -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.2.3/plugin/wavesurfer.regions.min.js"></script>
  <!-- css style -->
  <style type='text/css'>
  region.wavesurfer-region::before {
    content: attr(data-region-label);
    position: relative;
    border-style: solid;
    border-width: 1px;
    top: 2px;
  }

  h1 {
    margin-left: auto;
    margin-right: auto;
  }

  region.wavesurfer-region[data-region-highlight] {
    border: 3px solid rgb(86, 180, 239);
    box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.05) inset, 0px 0px 8px rgba(82, 168, 236, 0.6);
  }

  #waveform{
    position:relative;
    width:75%;
    margin-right: auto;
    margin-left: auto;
    /*border-style: solid;*/
    /*border-width: 3px;*/
    background-color:white;
  }

  </style>
</head>
<body>

  <h1>Record your imitation</h1>

  <p>Before you enable microphone input either plug in headphones or turn the volume down if you want to avoid ear splitting feedback!</p>

  <button id="startRecording" onclick="startRecording(this);" disabled>record</button>
  <button onclick="stopRecording(this);" disabled>stop</button>
  
  <h2>Log</h2>
  <pre id="log"></pre>

  <h2>Recorded output</h2>
  <p> Once you have stopped the recording, a waveform displaying the recorded audio will be displayed and you may play it back using the button below.</p>
  <div id="waveform"></div>
  <button id="playpause" onclick="clicked()" >Play/Pause</button>

  <script>
  document.getElementById('playpause').style.display="none";

  var wavesurfer = WaveSurfer.create({
    container: '#waveform',
    waveColor: 'violet',
    cursorColor: 000,
    progressColor: 'purple'
    //hideScrollbar: true,
  });



  var microphone = Object.create(WaveSurfer.Microphone);
  microphone.init({
      wavesurfer: wavesurfer
  });

  microphone.on('deviceReady', function(stream) {
      console.log('Device ready!', stream);
  });
  microphone.on('deviceError', function(code) {
      console.warn('Device error: ' + code);
  });

  

  console.log(wavesurfer.regions);


  function clicked() {
    if (wavesurfer.isPlaying()) {
        //document.getElementById("playpause").textContent = "Pause";
        wavesurfer.pause();
    } else {
        document.getElementById("playpause").textContent = "Play";
        wavesurfer.regions.list.oneRegion.play();
    }
  }




  function __log(e, data) {
    log.innerHTML += "\n" + e + " " + (data || '');
  }
  var audio_context;
  var recorder;
  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);
    __log('Media stream created.');

    recorder = new Recorder(input);
    __log('Recorder initialised.');

    document.getElementById("startRecording").disabled = false;
  }
  function startRecording(button) {
    recorder && recorder.record();
    button.disabled = true;
    button.nextElementSibling.disabled = false;
    microphone.start();
    __log('Recording...');
  }
  function stopRecording(button) {
    microphone.stop();
    microphone.destroy();
    recorder && recorder.stop();
    button.disabled = true;
    button.previousElementSibling.disabled = false;
    __log('Stopped recording.');
    
    // create waveform
    createWaveForm();
    recorder.clear();
  }
  function createWaveForm() {
    recorder && recorder.exportWAV(function(blob) {
      console.log(blob);
      var url = URL.createObjectURL(blob);
      wavesurfer.load(url);
      wavesurfer.on('ready', function() {
          wavesurfer.clearRegions();
          wavesurfer.addRegion({
            id: 'oneRegion',
            loop: false,
            start: 0,
            end: 0.99*wavesurfer.getDuration(),
            color: 'hsla(100, 100%, 40%, 0.69)',
            attributes: {
                label: 'The audio contained in this region will be sent to the search engine.'
            }
        });
      });
      
      document.getElementById('playpause').style.display="block";
    });
  }
  window.onload = function init() {
    try {
      // webkit shim
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
      window.URL = window.URL || window.webkitURL;
      
      audio_context = new AudioContext;
      __log('Audio context set up.');
      __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
    } catch (e) {
      alert('No web audio support in this browser!');
    }
    
    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
      __log('No live audio input: ' + e);
    });
  };
  </script>

  <script src="./recorder.js"></script>
</body>
</html>